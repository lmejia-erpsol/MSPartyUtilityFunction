xquery version "1.0" encoding "utf-8";

(:: OracleAnnotationVersion "1.0" ::)

declare namespace ns1="http://claro.com.ec/osb/message/Customer/IdentificationValidationMessage/v1";
(:: import schema at "../../../CanonicalModel/CanonicalModel/Messages/BSS/Customer/Schema/IdentificationValidationMessageV1.xsd" ::)

declare namespace functx = "http://www.fun.com";
declare function functx:contains-any-of
  ( $arg as xs:string? ,
    $searchStrings as xs:string* )  as xs:boolean {

   some $searchString in $searchStrings
   satisfies contains($arg,$searchString)
 } ;
declare variable $IdentificationValidationRequest as element() (:: schema-element(ns1:IdentificationValidationRequest) ::) external;
declare variable $identifierType as xs:string external;

declare function local:func($IdentificationValidationRequest as element() (:: schema-element(ns1:IdentificationValidationRequest) ::), $identifierType as xs:string) as xs:string {
   
 
             if ($identifierType='PAS') then    if (string ($IdentificationValidationRequest/identifierId)='' ) then ('Ingrese el tipo correcto de identificacion.')
        else if(fn:contains($IdentificationValidationRequest/identifierId, ' ') =true() )then 'El pasaporte no puede contener espacios'
        else if ( functx:contains-any-of($IdentificationValidationRequest/identifierId,(':','|','°','¬','#', '$','=','¡','!','¿','?','.', '{','}','*','+','~','^','½','"',';','<','>','%','(',')',',','/','\','-',')',',','.',']','[','¨','`','_', ''''))=true()
               or fn:contains($IdentificationValidationRequest/identifierId, '&#38;')=true() )
                                                                  then 'El pasaporte no puede contener caracteres especiales'
         else if ( xs:int ( fn:string-length($IdentificationValidationRequest/identifierId) )< 6 )then 'El pasaporte debe tener una longitud mínima de 6 caracteres'
        else if (string(fn:number($IdentificationValidationRequest/identifierId)) !='NaN') then 'El pasaporte no debe contener secuencias numéricas'
        else  if (matches(fn:lower-case($IdentificationValidationRequest/identifierId ), '[a-z]')=true() and matches($IdentificationValidationRequest/identifierId, '[0-9]') =false() )then 'El pasaporte no puede ser solo alfabetico'
        else if (string(fn:substring($IdentificationValidationRequest/identifierId,1,1))=string(fn:substring($IdentificationValidationRequest/identifierId,2,1))
                and string(fn:substring($IdentificationValidationRequest/identifierId,2,1))=string(fn:substring($IdentificationValidationRequest/identifierId,3,1))
               and string(fn:substring($IdentificationValidationRequest/identifierId,3,1))=string(fn:substring($IdentificationValidationRequest/identifierId,4,1))
               and string(fn:substring($IdentificationValidationRequest/identifierId,4,1))=string(fn:substring($IdentificationValidationRequest/identifierId,5,1))
               and string(fn:substring($IdentificationValidationRequest/identifierId,5,1))=string(fn:substring($IdentificationValidationRequest/identifierId,6,1))
       
        )then
        'El pasaporte no debe contener secuencias de caracteres'
        else('Operation Successfully Executed') 
        
        else if ($identifierType='RUC') then  if ( xs:int ( fn:string-length($IdentificationValidationRequest/identifierId) )!= 13 )then  'Ha especificado que esta identificación es RUC pero NO tiene los 13 dígitos'
                   else if (string(fn:number($IdentificationValidationRequest/identifierId)) ='NaN')then concat ( 'El Número de Indentificación tiene al menos una letra ' , $IdentificationValidationRequest/identifierId ,';')
                   else if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,2))<01 or xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,2))>24 )
                   then 'RUC Incorrecto. Los primeros 2 digitos no son permitidos'
                  else if (string(fn:substring($IdentificationValidationRequest/identifierId,11,3))!='001' ) then 'RUC Incorrecto. Los ultimos 3 digitos no son permitidos solo se permite 001'
                  else if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1))<6 ) 
                     then (                     
                      if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,10,1))= 
                  10-((
                     (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2          ) +
                    (xs:int(fn:substring($IdentificationValidationRequest/identifierId,2,1)) *1          ) +
                     (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2          ) +
                    (xs:int(fn:substring($IdentificationValidationRequest/identifierId,4,1)) *1          )  +
                    (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2          )  +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,6,1)) *1          ) +
                     (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,8,1)) *1          ) +
                       (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2          )) mod 10)) then 'Operation Successfully Executed'
                    else 'Identificación Inválida. Digito Verificador Incorrecto'
                    )        
                    
                     else if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1))=9 ) 
                     then ( 
                     
                      if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,10,1))= 
                  11-((
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *4          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,2,1)) *3          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,4,1)) *7          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *6          )  +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,6,1)) *5          )  +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *4          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,8,1)) *3          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2          )) mod 11)) then 'Operation Successfully Executed'
                    else 'Identificación Inválida. Digito Verificador Incorrecto para la SOCIEDAD PRIVADA o EXTRANJEROS SIN CEDULA'
                    )       
                    
                     else if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1))=6 ) 
                     then ( 
                     
                      if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1))= 
                  11-((
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *3          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,2,1)) *2          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *7          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,4,1)) *6          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *5          )  +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,6,1)) *4          )  +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *3          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,8,1)) *2          ) 
                     ) mod 11)) then 'Operation Successfully Executed'
                    else  'Identificación Inválida. Digito Verificador Incorrecto para la SOCIEDAD PUBLICA'
                    )        
                    
                    

         else ('Ingrese el tipo correcto de identificacion ')
         
             else if ($identifierType='CED') then  if ( xs:int ( fn:string-length($IdentificationValidationRequest/identifierId) )!= 10 )then  'Ha especificado que esta identificación es CED pero NO tiene 10 dígitos'
                   else if (string(fn:number($IdentificationValidationRequest/identifierId)) ='NaN')then concat ( 'El Número de Indentificación tiene al menos una letra ' , $IdentificationValidationRequest/identifierId ,';')
                   else if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,2))<01 or xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,2))>24 )
                   then 'CED Incorrecto. Los primeros 2 digitos no son permitidos'
                  else if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1))<6 ) 
                     then (     
                     
                      if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,10,1))=0 )
                      then 
                      
                      if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,10,1))= 
                  ((
                     (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2          ) +
                    (xs:int(fn:substring($IdentificationValidationRequest/identifierId,2,1)) *1          ) +
                     (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2          ) +
                    (xs:int(fn:substring($IdentificationValidationRequest/identifierId,4,1)) *1          )  +
                    (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2          )  +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,6,1)) *1          ) +
                     (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,8,1)) *1          ) +
                       (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2          )) mod 10)) 
                    then 'Operation Successfully Executed'
                    else 'Identificación Inválida. Digito Verificador Incorrecto'
                    
                    else if (xs:int(fn:substring($IdentificationValidationRequest/identifierId,10,1))= 
                  10-((
                     (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,1,1)) *2          ) +
                    (xs:int(fn:substring($IdentificationValidationRequest/identifierId,2,1)) *1          ) +
                     (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,3,1)) *2          ) +
                    (xs:int(fn:substring($IdentificationValidationRequest/identifierId,4,1)) *1          )  +
                    (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,5,1)) *2          )  +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,6,1)) *1          ) +
                     (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,7,1)) *2          ) +
                     (xs:int(fn:substring($IdentificationValidationRequest/identifierId,8,1)) *1          ) +
                       (if ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2 >=10) then (
                     xs:int(fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2 ),1,1)) +
                     xs:int( fn:substring(  string ( xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2 ),2,1) ))
                    else xs:int(fn:substring($IdentificationValidationRequest/identifierId,9,1)) *2          )) mod 10)) 
                    then 'Operation Successfully Executed'
                    else 'Identificación Inválida. Digito Verificador Incorrecto'
                    )        
                                 
                                  
                    

         else ('Ingrese el tipo correcto de identificacion ')
         
        else 'Ingresar el ID de identificación correcto '        
        
       
       
        
        
        
           
};

local:func($IdentificationValidationRequest , $identifierType)